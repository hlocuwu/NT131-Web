<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Button 3 Page</title>
    <link rel="stylesheet" href="../custom/styles.css">
</head>
<body>

<header>
    <div class="logo" onclick="location.href='/'">Logo</div>
    <div class="buttons">
        <button class="button" onclick="location.href='/camera'">Giám sát</button>
        <button class="button" onclick="location.href='/chart'">Thống kê</button>
        <button class="button" onclick="location.href='/setting'">Cài đặt</button>
    </div>
</header>

<div class="content">
    <h2>Thống kê té ngã</h2>
    
    <div class="chart-container">
        <h3 id="hourlyChartTitle">Té ngã theo giờ (Hôm nay: đang tải...)</h3>
        <canvas id="hourlyChart"></canvas>
    </div>
    
    <div class="chart-container">
        <h3 id="dailyChartTitle">Té ngã theo ngày (Tháng: đang tải...)</h3>
        <canvas id="dailyChart"></canvas>
    </div>
    
    <script>
        // Các đối tượng biểu đồ toàn cục
        let hourlyChart, dailyChart;
        
        // Khởi tạo biểu đồ khi trang tải xong
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCharts();
            // Cập nhật mỗi 10 giây
            setInterval(loadCharts, 10000);
        });
        
        async function loadCharts() {
            try {
                const response = await fetch('/fall_stats');
                const data = await response.json();
                
                // Cập nhật tiêu đề với ngày hiện tại
                const today = new Date();
                const formattedDate = today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear();
                document.getElementById('hourlyChartTitle').textContent = `Té ngã theo giờ (Hôm nay: ${formattedDate})`;
                
                // Cập nhật tiêu đề với tháng hiện tại
                const monthNames = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6', 
                                    'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
                document.getElementById('dailyChartTitle').textContent = `Té ngã theo ngày (${monthNames[today.getMonth()]} ${today.getFullYear()})`;
                
                // Xử lý dữ liệu theo giờ cho ngày hôm nay
                processHourlyData(data.day);
                
                // Xử lý dữ liệu theo ngày cho tháng hiện tại
                processDailyData(data.day);
                
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu thống kê:', error);
            }
        }
        
        function processHourlyData(dayData) {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            
            // Khởi tạo mảng chứa số lượng té ngã cho mỗi giờ (0-23)
            const hourCounts = Array(24).fill(0);
            const hourLabels = Array(24).fill().map((_, i) => `${i}:00`);
            
            // Tính tổng số té ngã theo giờ
            Object.keys(dayData).forEach(dateStr => {
                // Chỉ xử lý dữ liệu của ngày hôm nay
                if (dateStr.startsWith(today)) {
                    // Trích xuất giờ từ ngày và giờ (dạng YYYY-MM-DD_HH-MM-SS)
                    const timeStr = dateStr.split('_')[1];
                    if (timeStr) {
                        const hour = parseInt(timeStr.split('-')[0]);
                        if (!isNaN(hour) && hour >= 0 && hour < 24) {
                            hourCounts[hour] += dayData[dateStr];
                        }
                    }
                }
            });
            
            // Tạo hoặc cập nhật biểu đồ theo giờ
            if (!hourlyChart) {
                hourlyChart = createChart('hourlyChart', 'Số lượng té ngã', hourLabels, hourCounts, 'rgba(75, 192, 192, 0.7)', 'Giờ');
            } else {
                updateChart(hourlyChart, hourLabels, hourCounts);
            }
        }
        
        function processDailyData(dayData) {
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
            
            // Khởi tạo mảng chứa số lượng té ngã cho mỗi ngày trong tháng
            const dayCounts = Array(daysInMonth).fill(0);
            const dayLabels = Array(daysInMonth).fill().map((_, i) => `${i + 1}`);
            
            // Tính tổng số té ngã theo ngày
            Object.keys(dayData).forEach(dateStr => {
                // Chỉ xử lý dữ liệu của tháng hiện tại
                if (dateStr.startsWith(currentMonth)) {
                    const day = parseInt(dateStr.split('-')[2]);
                    if (!isNaN(day) && day > 0 && day <= daysInMonth) {
                        dayCounts[day - 1] += dayData[dateStr];
                    }
                }
            });
            
            // Tạo hoặc cập nhật biểu đồ theo ngày
            if (!dailyChart) {
                dailyChart = createChart('dailyChart', 'Số lượng té ngã', dayLabels, dayCounts, 'rgba(255, 99, 132, 0.7)', 'Ngày');
            } else {
                updateChart(dailyChart, dayLabels, dayCounts);
            }
        }
        
        function createChart(canvasId, label, labels, data, bgColor, xAxisLabel) {
            return new Chart(document.getElementById(canvasId), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: bgColor,
                        borderColor: bgColor.replace('0.7', '1'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Số lượng sự cố'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: xAxisLabel
                            }
                        }
                    }
                }
            });
        }
        
        function updateChart(chart, labels, data) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update();
        }
    </script>            
</div>
</body>
</html>
